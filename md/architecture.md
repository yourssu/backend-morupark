# 인프라 & K8s 리소스 아키텍처 다이어그램 (텍스트 시각화 및 트래픽 시퀀스)

본 문서는 GCP 인프라 환경과 GKE (Google Kubernetes Engine)에서 구동되는 티켓팅 시스템의 아키텍처와 **데이터 흐름(Sequence)**을 텍스트로 시각화한 형태입니다.

```text
+-----------------------------------------------------------------------------------+
|                                 [ Client Browser ]                                |
+-----------------------------------------------------------------------------------+
                                         | Access Token (userId, platformId 포함)
                                         | HTTPS 요청
+-----------------------------------------------------------------------------------+
|                            GCP 인프라 (VPC Network)                               |
|                                                                                   |
|  +-----------------------------------------------------------------------------+  |
|  | [ Public Subnet ]                                                           |  |
|  |  +-------------------------+                                                |  |
|  |  | Cloud Load Balancer (L7)|                                                |  |
|  |  +-------------------------+                                                |  |
|  +--------------|--------------------------------------------------------------+  |
|                 v                                                                 |
|  +-----------------------------------------------------------------------------+  |
|  | [ Private Subnet ]                                                          |  |
|  |                                                                             |  |
|  |   +---------------------------------------------------------------------+   |  |
|  |   | GKE Cluster (Google Managed)                                        |   |  |
|  |   |                                                                     |   |  |
|  |   |  +---------------------------------------------------------------+  |   |  |
|  |   |  | [ Control Plane (Master Node) - 구글에서 관리함 ]             |  |   |  |
|  |   |  | - API Server, Scheduler, Controller Manager, etcd             |  |   |  |
|  |   |  +---------------------------------------------------------------+  |   |  |
|  |   |          | (Kubelet 및 파드 제어/스케줄링)                          |   |  |
|  |   |          v                                                          |   |  |
|  |   |  +---------------------------------------------------------------+  |   |  |
|  |   |  | [ Worker Node Pool (우리가 띄우는 실제 애플리케이션 파드들) ] |  |   |  |
|  |   |  |                                                               |  |   |  |
|  |   |  |  +-------------+                                              |  |   |  |
|  |   |  |  |   Ingress   |                                              |  |   |  |
|  |   |  |  +------|------+                                              |  |   |  |
|  |   |  |         v                                                     |  |   |  |
|  |   |  |  +-------------+             +--------------+                 |  |   |  |
|  |   |  |  | API Gateway | <=========> | Auth Service | (인증 처리)     |  |   |  |
|  |   |  |  +------+------+             +--------------+                 |  |   |  |
|  |   |  |         |                                                     |  |   |  |
|  |   |  |         | ① 대기열 진입 (userId, platformId 전달)              |  |   |  |
|  |   |  |         v                                                     |  |   |  |
|  |   |  |  +-------------+       ② 대기열 순번 기록      +-------------------+|  |   |  |
|  |   |  |  |Queue Service| <=========================> | Redis StatefulSet ||  |   |  |
|  |   |  |  +----+-^-+----+       ③ 스케줄링으로 대기열 돌파 +-------------------+|  |   |  |
|  |   |  |       | | |                        (상태변경)                 |  |   |  |
|  |   |  |       | | |                                                   |  |   |  |
|  |   |  |       | | +--------------------------+                        |  |   |  |
|  |   |  |       | | ⑧ Consume                  |                        |  |   |  |
|  |   |  |       | |                            v                        |  |   |  |
|  |   |  |       | |                       +---------+                   |  |   |  |
|  |   |  |       | | ④ Produce             |         |                   |  |   |  |
|  |   |  |       | +---------------------> |         |                   |  |   |  |
|  |   |  |       |                         |  Kafka  |                   |  |   |  |
|  |   |  |       |                         |         |                   |  |   |  |
|  |   |  |       |                         |         |                   |  |   |  |
|  |   |  |       |  +--------------------+ |         |                   |  |   |  |
|  |   |  |       |  | ⑤ Consume          | |         |                   |  |   |  |
|  |   |  |       |  |                    v |         |                   |  |   |  |
|  |   |  |       |  |              +---------+       |                   |  |   |  |
|  |   |  |       |  |              |  Goods  | ----> +                   |  |   |  |
|  |   |  |       |  +--------------+ Service | ⑦ Produce                 |  |   |  |
|  |   |  |       |                 +----+----+   (당첨자 목록)           |  |   |  |
|  |   |  |       |                      |                                |  |   |  |
|  |   |  +-------|----------------------|--------------------------------+  |   |  |
|  |   |          |                      | ⑥ 당첨자 등록                      |   |  |
|  |   +----------|----------------------|-----------------------------------+   |  |
|  |              |                      |                                       |  |
|  |              v                      v                                       |  |
|  |      +---------------+       +---------------+                              |  |
|  |      | Managed Kafka |       |  Cloud SQL    |                              |  |
|  |      | (위의 로직상   |       | (PostgreSQL/) |                              |  |
|  |      |  Kafka와 동일) |       |  (MySQL)      |                              |  |
|  |      +---------------+       +---------------+                              |  |
|  |                                                                             |  |
|  +-----------------------------------------------------------------------------+  |
+-----------------------------------------------------------------------------------+
*(참고: 그림의 복잡도를 줄이기 위해 K8s 내부 파드간 통신 및 외부 연결 객체(Kafka, DB)를 논리적인 선으로 연결하였습니다. K8s 안의 Kafka 박스는 하단의 Managed Kafka로 이어지는 논리적 통신 흐름을 나타냅니다.)*
```

## 시스템 트래픽 흐름 (① ~ ⑧ 상세 시퀀스)

업로드해주신 손그림 다이어그램의 트래픽 흐름을 기반으로 작성된 상세 시퀀스입니다.

1.  **① 대기열 진입 (클라이언트 ➔ API Gateway ➔ Queue)**
    *   클라이언트가 `userId`, `platformId` 등이 포함된 Access Token과 함께 요청을 보냅니다.
    *   API Gateway는 Auth Service를 통해 인증(Token 유효성 검증)을 처리한 뒤, Queue Service로 트래픽을 넘깁니다.
2.  **② 대기열 순번 (Queue ↔ Redis)**
    *   Queue Service는 Redis에 유저 정보를 등록하고 부여된 대기열 등수(순번)를 확인하고 상태를 기록합니다. (ZSET 활용)
3.  **③ 스케줄링으로 대기열 돌파 (Redis ➔ Queue)**
    *   Queue 파드 내부의 스케줄러가 주기적으로 확인하여, 본인 차례가 된 유저들의 상태를 '처리 중(통과)'으로 변경합니다.
4.  **④ 이벤트 발행 (Queue ➔ Kafka / Produce)**
    *   대기열을 통과한 유저의 요청 정보를 Kafka(예: `waiting-queue-topic`)로 Produce(전송)합니다.
5.  **⑤ 이벤트 구독 및 처리 (Kafka ➔ Goods / Consume)**
    *   Goods Service가 Kafka로부터 메시지를 Consume(수신)하여 실제 이벤트(5% 당첨 확률)를 계산하고 코어 비즈니스 로직 및 재고 처리를 수행합니다.
6.  **⑥ 당첨자 등록 (Goods ➔ Cloud SQL(PostgreSQL))**
    *   처리가 완료된 데이터(성공/실패 여부, 재고 차감 기록, 당첨자 등록)를 원자적(Atomic) 트랜잭션으로 Cloud SQL (PostgreSQL 또는 MySQL)에 기록합니다.
7.  **⑦ 결과 발행 (Goods ➔ Kafka / Produce)**
    *   DB 기록까지 마친 후, Goods Service는 처리 결과(당첨자 목록 등)를 Kafka(예: `result-notification-topic`)로 다시 Produce 합니다.
8.  **⑧ 결과 반환 (Kafka ➔ Queue / Consume)**
    *   Queue Service가 Kafka의 결과 이벤트를 Consume하여 수신한 뒤, 클라이언트에게 최종 당첨 여부를 반환(Polling 또는 SSE)하여 전체 흐름을 종료합니다.

## K8s 오토스케일링 및 보안

*   **HPA (Horizontal Pod Autoscaler)**: Queue Service와 Goods Service는 CPU 메트릭 60%를 기준으로 파드 개수가 유연하게 조절됩니다.
*   **Headless Service**: Redis StatefulSet의 각 파드에는 고유한 DNS가 부여되어 시스템 간 통신의 신뢰성을 높입니다.
*   **Private Subnet**: GKE Worker Node, Cloud SQL, Redis, 연동형 Kafka는 모두 외부에 직접 노출되지 않은 Private Subnet에 위치합니다.
